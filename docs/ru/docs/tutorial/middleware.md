# Middleware (–ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —Å–ª–æ–π) { #middleware }

–í—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —Å–ª–æ–π (middleware) –≤ **FastAPI** –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.

"Middleware" —ç—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å –∫–∞–∂–¥—ã–º –∑–∞–ø—Ä–æ—Å–æ–º –¥–æ –µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–∞–∫–æ–π-–ª–∏–±–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π *–æ–ø–µ—Ä–∞—Ü–∏–µ–π –ø—É—Ç–∏*.
–ê —Ç–∞–∫–∂–µ —Å –∫–∞–∂–¥—ã–º –æ—Ç–≤–µ—Ç–æ–º –ø–µ—Ä–µ–¥ –µ–≥–æ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º.


* –û–Ω–∞ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∫–∞–∂–¥—ã–π –ø–æ—Å—Ç—É–ø–∞—é—â–∏–π **–∑–∞–ø—Ä–æ—Å**.
* –ú–æ–∂–µ—Ç —á—Ç–æ-—Ç–æ —Å–¥–µ–ª–∞—Ç—å —Å —ç—Ç–∏–º **–∑–∞–ø—Ä–æ—Å–æ–º** –∏–ª–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ª—é–±–æ–π –Ω—É–∂–Ω—ã–π –∫–æ–¥.
* –ó–∞—Ç–µ–º –ø–µ—Ä–µ–¥–∞–µ—Ç **–∑–∞–ø—Ä–æ—Å** –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ (–∫–∞–∫–æ–π-–ª–∏–±–æ *–æ–ø–µ—Ä–∞—Ü–∏–µ–π –ø—É—Ç–∏*).
* –ü–æ–ª—É—á–∞–µ—Ç **–æ—Ç–≤–µ—Ç** (–æ—Ç *–æ–ø–µ—Ä–∞—Ü–∏–∏ –ø—É—Ç–∏*).
* –ú–æ–∂–µ—Ç —á—Ç–æ-—Ç–æ —Å–¥–µ–ª–∞—Ç—å —Å —ç—Ç–∏–º **–æ—Ç–≤–µ—Ç–æ–º** –∏–ª–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ª—é–±–æ–π –Ω—É–∂–Ω—ã–π –∫–æ–¥.
* –ò –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç **–æ—Ç–≤–µ—Ç**.

/// note | –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

–ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —Å `yield`, —Ç–æ –∫–æ–¥ –≤—ã—Ö–æ–¥–∞ (–∫–æ–¥ –ø–æ—Å–ª–µ `yield`) –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è *–ø–æ—Å–ª–µ* middleware.

–ï—Å–ª–∏ –±—ã–ª–∏ –∫–∞–∫–∏–µ‚Äë–ª–∏–±–æ —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ (—Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞—é—Ç—Å—è –≤ —Ä–∞–∑–¥–µ–ª–µ [–§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏](background-tasks.md){.internal-link target=_blank}, –≤—ã —É–≤–∏–¥–∏—Ç–µ —ç—Ç–æ –ø–æ–∑–∂–µ), –æ–Ω–∏ –±—É–¥—É—Ç –∑–∞–ø—É—â–µ–Ω—ã *–ø–æ—Å–ª–µ* –≤—Å–µ—Ö middleware.

///

## –°–æ–∑–¥–∞–Ω–∏–µ middleware { #create-a-middleware }

–î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è middleware –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä `@app.middleware("http")`.

–§—É–Ω–∫—Ü–∏—è middleware –ø–æ–ª—É—á–∞–µ—Ç:

* `request` (–æ–±—ä–µ–∫—Ç –∑–∞–ø—Ä–æ—Å–∞).
* –§—É–Ω–∫—Ü–∏—é `call_next`, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–ª—É—á–∞–µ—Ç `request` –≤ –∫–∞—á–µ—Å—Ç–≤–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞.
    * –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–¥–∞—ë—Ç `request` —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π *–æ–ø–µ—Ä–∞—Ü–∏–∏ –ø—É—Ç–∏*.
    * –ó–∞—Ç–µ–º –æ–Ω–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–≤–µ—Ç `response`, —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π *–æ–ø–µ—Ä–∞—Ü–∏–µ–π –ø—É—Ç–∏*.
* –¢–∞–∫–∂–µ –∏–º–µ–µ—Ç—Å—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤–∏–¥–æ–∏–∑–º–µ–Ω–∏—Ç—å `response`, –ø–µ—Ä–µ–¥ —Ç–µ–º –∫–∞–∫ –µ–≥–æ –≤–µ—Ä–Ω—É—Ç—å.

{* ../../docs_src/middleware/tutorial001.py hl[8:9,11,14] *}

/// tip | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ

–ò–º–µ–π—Ç–µ –≤ –≤–∏–¥—É, —á—Ç–æ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å —Å–≤–æ–∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers" class="external-link" target="_blank">–ø—Ä–∏ –ø–æ–º–æ—â–∏ –ø—Ä–µ—Ñ–∏–∫—Å–∞ 'X-'</a>.

–ï—Å–ª–∏ –∂–µ –≤—ã —Ö–æ—Ç–∏—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –∫–ª–∏–µ–Ω—Ç —Å–º–æ–∂–µ—Ç —É–≤–∏–¥–µ—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ, —Ç–æ –≤–∞–º –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å –∏—Ö –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ CORS ([CORS (Cross-Origin Resource Sharing)](cors.md){.internal-link target=_blank}), –∏—Å–ø–æ–ª—å–∑—É—è –ø–∞—Ä–∞–º–µ—Ç—Ä `expose_headers`, —Å–º. –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é <a href="https://www.starlette.io/middleware/#corsmiddleware" class="external-link" target="_blank">Starlette's CORS docs</a>.

///

/// note | –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

–í—ã —Ç–∞–∫–∂–µ –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `from starlette.requests import Request`.

**FastAPI** –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–∞–∫–æ–π –¥–æ—Å—Ç—É–ø –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤. –ù–æ, –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ, —ç—Ç–æ `Request` –∏–∑ Starlette.

///

### –î–æ –∏ –ø–æ—Å–ª–µ `response` { #before-and-after-the-response }

–í—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–¥, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–π `request` –¥–æ –ø–µ—Ä–µ–¥–∞—á–∏ –µ–≥–æ –∫–∞–∫–æ–π-–ª–∏–±–æ *–æ–ø–µ—Ä–∞—Ü–∏–∏ –ø—É—Ç–∏*.

–ê —Ç–∞–∫–∂–µ –ø–æ—Å–ª–µ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è `response`, –¥–æ —Ç–æ–≥–æ, –∫–∞–∫ –≤—ã –µ–≥–æ –≤–µ—Ä–Ω—ë—Ç–µ.

–ù–∞–ø—Ä–∏–º–µ—Ä, –≤—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ `X-Process-Time`, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –≤—Ä–µ–º—è –≤ —Å–µ–∫—É–Ω–¥–∞—Ö, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞:

{* ../../docs_src/middleware/tutorial001.py hl[10,12:13] *}

/// tip | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ

–ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º <a href="https://docs.python.org/3/library/time.html#time.perf_counter" class="external-link" target="_blank">`time.perf_counter()`</a> –≤–º–µ—Å—Ç–æ `time.time()` –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –±–æ–ª—å—à–µ–π —Ç–æ—á–Ω–æ—Å—Ç–∏ –Ω–∞—à–∏—Ö –ø—Ä–∏–º–µ—Ä–æ–≤. ü§ì

///

## –ü–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö middleware { #multiple-middleware-execution-order }

–ö–æ–≥–¥–∞ –≤—ã –¥–æ–±–∞–≤–ª—è–µ—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ middleware —Å –ø–æ–º–æ—â—å—é –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–∞ `@app.middleware()` –∏–ª–∏ –º–µ—Ç–æ–¥–∞ `app.add_middleware()`, –∫–∞–∂–¥–æ–µ –Ω–æ–≤–æ–µ middleware –æ–±–æ—Ä–∞—á–∏–≤–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, —Ñ–æ—Ä–º–∏—Ä—É—è —Å—Ç–µ–∫. –ü–æ—Å–ª–µ–¥–Ω–µ–µ –¥–æ–±–∞–≤–ª–µ–Ω–Ω–æ–µ middleware ‚Äî —Å–∞–º–æ–µ –≤–Ω–µ—à–Ω–µ–µ (*outermost*), –∞ –ø–µ—Ä–≤–æ–µ ‚Äî —Å–∞–º–æ–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ (*innermost*).

–ù–∞ –ø—É—Ç–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ —Å–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å–∞–º–æ–µ –≤–Ω–µ—à–Ω–µ–µ middleware.

–ù–∞ –ø—É—Ç–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ–Ω–æ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–º.

–ù–∞–ø—Ä–∏–º–µ—Ä:

```Python
app.add_middleware(MiddlewareA)
app.add_middleware(MiddlewareB)
```

–≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –ø–æ—Ä—è–¥–∫—É –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:

* **–ó–∞–ø—Ä–æ—Å**: MiddlewareB ‚Üí MiddlewareA ‚Üí –º–∞—Ä—à—Ä—É—Ç

* **–û—Ç–≤–µ—Ç**: –º–∞—Ä—à—Ä—É—Ç ‚Üí MiddlewareA ‚Üí MiddlewareB

–¢–∞–∫–æ–µ —Å—Ç–µ–∫–æ–≤–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–π –∏ —É–ø—Ä–∞–≤–ª—è–µ–º—ã–π –ø–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è middleware.

## –î—Ä—É–≥–∏–µ middleware { #other-middlewares }

–û –¥—Ä—É–≥–∏—Ö middleware –≤—ã –º–æ–∂–µ—Ç–µ —É–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ –≤ —Ä–∞–∑–¥–µ–ª–µ [Advanced User Guide: Advanced Middleware](../advanced/middleware.md){.internal-link target=_blank}.

–í —Å–ª–µ–¥—É—é—â–µ–º —Ä–∞–∑–¥–µ–ª–µ –≤—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ—á–∏—Ç–∞—Ç—å, –∫–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å <abbr title="Cross-Origin Resource Sharing ‚Äì —Å–æ–≤–º–µ—Å—Ç–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ –º–µ–∂–¥—É –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏">CORS</abbr> —Å –ø–æ–º–æ—â—å—é middleware.
