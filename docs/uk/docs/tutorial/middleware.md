# Middleware { #middleware }

–£ **FastAPI** –º–æ–∂–Ω–∞ –¥–æ–¥–∞–≤–∞—Ç–∏ middleware.

¬´Middleware¬ª ‚Äî —Ü–µ —Ñ—É–Ω–∫—Ü—ñ—è, —è–∫–∞ –ø—Ä–∞—Ü—é—î –∑ –∫–æ–∂–Ω–∏–º **–∑–∞–ø–∏—Ç–æ–º** –ø–µ—Ä–µ–¥ –π–æ–≥–æ –æ–±—Ä–æ–±–∫–æ—é –±—É–¥—å-—è–∫–æ—é –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ—é *–æ–ø–µ—Ä–∞—Ü—ñ—î—é —à–ª—è—Ö—É*. –ê —Ç–∞–∫–æ–∂ –∑ –∫–æ–∂–Ω–æ—é **–≤—ñ–¥–ø–æ–≤—ñ–¥–¥—é** –ø–µ—Ä–µ–¥ —ó—ó –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è–º.

* –í–æ–Ω–∞ –æ—Ç—Ä–∏–º—É—î –∫–æ–∂–µ–Ω **–∑–∞–ø–∏—Ç**, —â–æ –Ω–∞–¥—Ö–æ–¥–∏—Ç—å –¥–æ –≤–∞—à–æ–≥–æ –∑–∞—Å—Ç–æ—Å—É–Ω–∫—É.
* –ü–æ—Ç—ñ–º –≤–æ–Ω–∞ –º–æ–∂–µ –≤–∏–∫–æ–Ω–∞—Ç–∏ –ø–µ–≤–Ω—ñ –¥—ñ—ó —ñ–∑ —Ü–∏–º **–∑–∞–ø–∏—Ç–æ–º** –∞–±–æ –∑–∞–ø—É—Å—Ç–∏—Ç–∏ –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏–π –∫–æ–¥.
* –î–∞–ª—ñ –≤–æ–Ω–∞ –ø–µ—Ä–µ–¥–∞—î **–∑–∞–ø–∏—Ç** –¥–ª—è –æ–±—Ä–æ–±–∫–∏ —Ä–µ—à—Ç–æ—é –∑–∞—Å—Ç–æ—Å—É–Ω–∫—É (—è–∫–æ—é—Å—å *–æ–ø–µ—Ä–∞—Ü—ñ—î—é —à–ª—è—Ö—É*).
* –ü–æ—Ç—ñ–º –≤–æ–Ω–∞ –æ—Ç—Ä–∏–º—É—î **–≤—ñ–¥–ø–æ–≤—ñ–¥—å**, —Å—Ñ–æ—Ä–º–æ–≤–∞–Ω—É –∑–∞—Å—Ç–æ—Å—É–Ω–∫–æ–º (—è–∫–æ—é—Å—å *–æ–ø–µ—Ä–∞—Ü—ñ—î—é —à–ª—è—Ö—É*).
* –í–æ–Ω–∞ –º–æ–∂–µ –≤–∏–∫–æ–Ω–∞—Ç–∏ –ø–µ–≤–Ω—ñ –¥—ñ—ó —ñ–∑ —Ü—ñ—î—é **–≤—ñ–¥–ø–æ–≤—ñ–¥–¥—é** –∞–±–æ –∑–∞–ø—É—Å—Ç–∏—Ç–∏ –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏–π –∫–æ–¥.
* –ü–æ—Ç—ñ–º –≤–æ–Ω–∞ –ø–æ–≤–µ—Ä—Ç–∞—î **–≤—ñ–¥–ø–æ–≤—ñ–¥—å**.

/// note | –¢–µ—Ö–Ω—ñ—á–Ω—ñ –¥–µ—Ç–∞–ª—ñ

–Ø–∫—â–æ —É –≤–∞—Å —î –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –∑ `yield`, –∫–æ–¥ –≤–∏—Ö–æ–¥—É –≤–∏–∫–æ–Ω–∞—î—Ç—å—Å—è *–ø—ñ—Å–ª—è* middleware.

–Ø–∫—â–æ –±—É–ª–∏ –∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω—ñ —Ñ–æ–Ω–æ–≤—ñ –∑–∞–¥–∞—á—ñ (—Ä–æ–∑–≥–ª—è–Ω—É—Ç–æ –≤ —Ä–æ–∑–¥—ñ–ª—ñ [Background Tasks](background-tasks.md){.internal-link target=_blank}, –≤–∏ –ø–æ–±–∞—á–∏—Ç–µ —Ü–µ –ø—ñ–∑–Ω—ñ—à–µ), –≤–æ–Ω–∏ –≤–∏–∫–æ–Ω–∞—é—Ç—å—Å—è *–ø—ñ—Å–ª—è* –≤—Å—ñ—Ö middleware.

///

## –°—Ç–≤–æ—Ä–µ–Ω–Ω—è middleware { #create-a-middleware }

–©–æ–± —Å—Ç–≤–æ—Ä–∏—Ç–∏ middleware, –≤–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç–µ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä `@app.middleware("http")` –Ω–∞–¥ —Ñ—É–Ω–∫—Ü—ñ—î—é.

–§—É–Ω–∫—Ü—ñ—è middleware –æ—Ç—Ä–∏–º—É—î:

* `request`.
* –§—É–Ω–∫—Ü—ñ—é `call_next`, —è–∫–∞ –æ—Ç—Ä–∏–º–∞—î `request` —è–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä.
    * –¶—è —Ñ—É–Ω–∫—Ü—ñ—è –ø–µ—Ä–µ–¥–∞—Å—Ç—å `request` –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ–π *–æ–ø–µ—Ä–∞—Ü—ñ—ó —à–ª—è—Ö—É*.
    * –ü–æ—Ç—ñ–º –≤–æ–Ω–∞ –ø–æ–≤–µ—Ä–Ω–µ `response`, –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ—é *–æ–ø–µ—Ä–∞—Ü—ñ—î—é —à–ª—è—Ö—É*.
* –ü–æ—Ç—ñ–º –≤–∏ –º–æ–∂–µ—Ç–µ –¥–æ–¥–∞—Ç–∫–æ–≤–æ –∑–º—ñ–Ω–∏—Ç–∏ `response` –ø–µ—Ä–µ–¥ —Ç–∏–º, —è–∫ –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ —ó—ó.

{* ../../docs_src/middleware/tutorial001_py39.py hl[8:9,11,14] *}

/// tip | –ü–æ—Ä–∞–¥–∞

–ü–∞–º‚Äô—è—Ç–∞–π—Ç–µ, —â–æ –≤–ª–∞—Å–Ω—ñ –ø—Ä–æ–ø—Ä—ñ—î—Ç–∞—Ä–Ω—ñ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –º–æ–∂–Ω–∞ –¥–æ–¥–∞–≤–∞—Ç–∏ <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers" class="external-link" target="_blank">–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ –ø—Ä–µ—Ñ—ñ–∫—Å `X-`</a>.

–ê–ª–µ —è–∫—â–æ —É –≤–∞—Å —î –≤–ª–∞—Å–Ω—ñ –∑–∞–≥–æ–ª–æ–≤–∫–∏, —è–∫—ñ –≤–∏ —Ö–æ—á–µ—Ç–µ, —â–æ–± –∫–ª—ñ—î–Ω—Ç —É –±—Ä–∞—É–∑–µ—Ä—ñ –º—ñ–≥ –ø–æ–±–∞—á–∏—Ç–∏, –ø–æ—Ç—Ä—ñ–±–Ω–æ –¥–æ–¥–∞—Ç–∏ —ó—Ö –¥–æ –≤–∞—à–∏—Ö –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π CORS ([CORS (Cross-Origin Resource Sharing)](cors.md){.internal-link target=_blank}) –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ `expose_headers`, –æ–ø–∏—Å–∞–Ω–æ–≥–æ –≤ <a href="https://www.starlette.dev/middleware/#corsmiddleware" class="external-link" target="_blank">–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—ó Starlette –ø–æ CORS</a>.

///

/// note | –¢–µ—Ö–Ω—ñ—á–Ω—ñ –¥–µ—Ç–∞–ª—ñ

–í–∏ —Ç–∞–∫–æ–∂ –º–æ–∂–µ—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ `from starlette.requests import Request`.

**FastAPI** –Ω–∞–¥–∞—î —Ü–µ –¥–ª—è –≤–∞—à–æ—ó –∑—Ä—É—á–Ω–æ—Å—Ç—ñ —è–∫ —Ä–æ–∑—Ä–æ–±–Ω–∏–∫–∞. –ê–ª–µ –≤–æ–Ω–æ –ø–æ—Ö–æ–¥–∏—Ç—å –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ –∑—ñ Starlette.

///

### –î–æ —ñ –ø—ñ—Å–ª—è `response` { #before-and-after-the-response }

–í–∏ –º–æ–∂–µ—Ç–µ –¥–æ–¥–∞—Ç–∏ –∫–æ–¥, —è–∫–∏–π –±—É–¥–µ –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏—Å—è –∑ `request`, –¥–æ —Ç–æ–≥–æ, —è–∫ –π–æ–≥–æ –æ—Ç—Ä–∏–º–∞—î –±—É–¥—å-—è–∫–∞ *–æ–ø–µ—Ä–∞—Ü—ñ—è —à–ª—è—Ö—É*.

–¢–∞–∫–æ–∂ –≤–∏ –º–æ–∂–µ—Ç–µ –¥–æ–¥–∞—Ç–∏ –∫–æ–¥, —è–∫–∏–π –±—É–¥–µ –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏—Å—è –ø—ñ—Å–ª—è —Ç–æ–≥–æ, —è–∫ `response` –±—É–¥–µ –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ, –ø–µ—Ä–µ–¥ —Ç–∏–º —è–∫ —ó—ó –ø–æ–≤–µ—Ä–Ω—É—Ç–∏.

–ù–∞–ø—Ä–∏–∫–ª–∞–¥, –≤–∏ –º–æ–∂–µ—Ç–µ –¥–æ–¥–∞—Ç–∏ –≤–ª–∞—Å–Ω–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ `X-Process-Time`, —è–∫–∏–π –º—ñ—Å—Ç–∏—Ç–∏–º–µ —á–∞—Å —É —Å–µ–∫—É–Ω–¥–∞—Ö, —è–∫–∏–π –≤–∏—Ç—Ä–∞—Ç–∏–≤—Å—è –Ω–∞ –æ–±—Ä–æ–±–∫—É –∑–∞–ø–∏—Ç—É —Ç–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—é –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ:

{* ../../docs_src/middleware/tutorial001_py39.py hl[10,12:13] *}

/// tip | –ü–æ—Ä–∞–¥–∞

–¢—É—Ç –º–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ <a href="https://docs.python.org/3/library/time.html#time.perf_counter" class="external-link" target="_blank">`time.perf_counter()`</a> –∑–∞–º—ñ—Å—Ç—å `time.time()` –æ—Å–∫—ñ–ª—å–∫–∏ –≤—ñ–Ω –º–æ–∂–µ –±—É—Ç–∏ –±—ñ–ª—å—à —Ç–æ—á–Ω–∏–º –¥–ª—è —Ç–∞–∫–∏—Ö –≤–∏–ø–∞–¥–∫—ñ–≤. ü§ì

///

## –ü–æ—Ä—è–¥–æ–∫ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∫—ñ–ª—å–∫–æ—Ö middleware { #multiple-middleware-execution-order }

–ö–æ–ª–∏ –≤–∏ –¥–æ–¥–∞—î—Ç–µ –∫—ñ–ª—å–∫–∞ middleware, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ –∞–±–æ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä `@app.middleware()` –∞–±–æ –º–µ—Ç–æ–¥ `app.add_middleware()`, –∫–æ–∂–µ–Ω –Ω–æ–≤–∏–π middleware –æ–±–≥–æ—Ä—Ç–∞—î –∑–∞—Å—Ç–æ—Å—É–Ω–æ–∫, —É—Ç–≤–æ—Ä—é—é—á–∏ —Å—Ç–µ–∫. –û—Å—Ç–∞–Ω–Ω—ñ–π –¥–æ–¥–∞–Ω–∏–π middleware —î *–∑–æ–≤–Ω—ñ—à–Ω—ñ–º*, –∞ –ø–µ—Ä—à–∏–π ‚Äî *–≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ–º*.

–ù–∞ —à–ª—è—Ö—É –∑–∞–ø–∏—Ç—É –ø–µ—Ä—à–∏–º –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è *–∑–æ–≤–Ω—ñ—à–Ω—ñ–π* middleware.

–ù–∞ —à–ª—è—Ö—É –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –≤—ñ–Ω –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –æ—Å—Ç–∞–Ω–Ω—ñ–º.

–ù–∞–ø—Ä–∏–∫–ª–∞–¥:

```Python
app.add_middleware(MiddlewareA)
app.add_middleware(MiddlewareB)
```

–¶–µ –ø—Ä–∏–∑–≤–æ–¥–∏—Ç—å –¥–æ —Ç–∞–∫–æ–≥–æ –ø–æ—Ä—è–¥–∫—É –≤–∏–∫–æ–Ω–∞–Ω–Ω—è:

* **–ó–∞–ø–∏—Ç**: MiddlewareB ‚Üí MiddlewareA ‚Üí route

* **–í—ñ–¥–ø–æ–≤—ñ–¥—å**: route ‚Üí MiddlewareA ‚Üí MiddlewareB

–¢–∞–∫–∞ –ø–æ–≤–µ–¥—ñ–Ω–∫–∞ —Å—Ç–µ–∫—É –≥–∞—Ä–∞–Ω—Ç—É—î, —â–æ middleware –≤–∏–∫–æ–Ω—É—é—Ç—å—Å—è —É –ø–µ—Ä–µ–¥–±–∞—á—É–≤–∞–Ω–æ–º—É —Ç–∞ –∫–µ—Ä–æ–≤–∞–Ω–æ–º—É –ø–æ—Ä—è–¥–∫—É.

## –Ü–Ω—à—ñ middlewares { #other-middlewares }

–í–∏ –º–æ–∂–µ—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ –ø—Ä–æ—á–∏—Ç–∞—Ç–∏ –±—ñ–ª—å—à–µ –ø—Ä–æ —ñ–Ω—à—ñ middlewares –≤ [Advanced User Guide: Advanced Middleware](../advanced/middleware.md){.internal-link target=_blank}.

–í–∏ –¥—ñ–∑–Ω–∞—î—Ç–µ—Å—å, —è–∫ –æ–±—Ä–æ–±–ª—è—Ç–∏ <abbr title="Cross-Origin Resource Sharing">CORS</abbr> –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é middleware –≤ –Ω–∞—Å—Ç—É–ø–Ω–æ–º—É —Ä–æ–∑–¥—ñ–ª—ñ.
