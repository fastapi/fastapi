# Middleware (–ü—Ä–æ–º—ñ–∂–Ω–∏–π —à–∞—Ä)

–£ **FastAPI** –º–æ–∂–Ω–∞ –¥–æ–¥–∞–≤–∞—Ç–∏ middleware (–ø—Ä–æ–º—ñ–∂–Ω–∏–π —à–∞—Ä).

"Middleware" ‚Äî —Ü–µ —Ñ—É–Ω–∫—Ü—ñ—è, —è–∫–∞ –ø—Ä–∞—Ü—é—î –∑ –∫–æ–∂–Ω–∏–º **–∑–∞–ø–∏—Ç–æ–º** –ø–µ—Ä–µ–¥ –π–æ–≥–æ –æ–±—Ä–æ–±–∫–æ—é –±—É–¥—å-—è–∫–æ—é –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ—é *–æ–ø–µ—Ä–∞—Ü—ñ—î—é —à–ª—è—Ö—É* (*path operation*), –∞ —Ç–∞–∫–æ–∂ –∑ –∫–æ–∂–Ω–æ—é **–≤—ñ–¥–ø–æ–≤—ñ–¥–¥—é** –ø–µ—Ä–µ–¥ —ó—ó –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è–º.

* Middleware –æ—Ç—Ä–∏–º—É—î –∫–æ–∂–µ–Ω **–∑–∞–ø–∏—Ç**, —â–æ –Ω–∞–¥—Ö–æ–¥–∏—Ç—å –¥–æ –í–∞—à–æ–≥–æ –∑–∞—Å—Ç–æ—Å—É–Ω–∫—É.
* –ú–æ–∂–µ –≤–∏–∫–æ–Ω–∞—Ç–∏ –ø–µ–≤–Ω—ñ –¥—ñ—ó —ñ–∑ —Ü–∏–º **–∑–∞–ø–∏—Ç–æ–º** –∞–±–æ –∑–∞–ø—É—Å—Ç–∏—Ç–∏ –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏–π –∫–æ–¥.
* –î–∞–ª—ñ –ø–µ—Ä–µ–¥–∞—î **–∑–∞–ø–∏—Ç** –¥–ª—è –æ–±—Ä–æ–±–∫–∏ –æ—Å–Ω–æ–≤–Ω–∏–º –∑–∞—Å—Ç–æ—Å—É–Ω–∫–æ–º (*–æ–ø–µ—Ä–∞—Ü—ñ—î—é —à–ª—è—Ö—É*).
* –û—Ç—Ä–∏–º—É—î **–≤—ñ–¥–ø–æ–≤—ñ–¥—å**, —Å—Ñ–æ—Ä–º–æ–≤–∞–Ω—É –∑–∞—Å—Ç–æ—Å—É–Ω–∫–æ–º (*–æ–ø–µ—Ä–∞—Ü—ñ—î—é —à–ª—è—Ö—É*).
* –ú–æ–∂–µ –∑–º—ñ–Ω–∏—Ç–∏ —Ü—é **–≤—ñ–¥–ø–æ–≤—ñ–¥—å** –∞–±–æ –≤–∏–∫–æ–Ω–∞—Ç–∏ –¥–æ–¥–∞—Ç–∫–æ–≤–∏–π –∫–æ–¥.
* –ü–æ–≤–µ—Ä—Ç–∞—î **–≤—ñ–¥–ø–æ–≤—ñ–¥—å** –∫–ª—ñ—î–Ω—Ç—É.

/// note | –¢–µ—Ö–Ω—ñ—á–Ω—ñ –¥–µ—Ç–∞–ª—ñ

–Ø–∫—â–æ —É –í–∞—Å —î –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –∑ `yield`, –∫–æ–¥ –≤–∏—Ö–æ–¥—É –≤–∏–∫–æ–Ω–∞—î—Ç—å—Å—è *–ø—ñ—Å–ª—è* middleware.

–Ø–∫—â–æ –±—É–ª–∏ –∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω—ñ —Ñ–æ–Ω–æ–≤—ñ –∑–∞–¥–∞—á—ñ (background tasks - —Ä–æ–∑–≥–ª—è–Ω—É—Ç–æ –¥–∞–ª—ñ), –≤–æ–Ω–∏ –≤–∏–∫–æ–Ω–∞—é—Ç—å—Å—è *–ø—ñ—Å–ª—è* –≤—Å—ñ—Ö middleware.

///

## –°—Ç–≤–æ—Ä–µ–Ω–Ω—è middleware

–©–æ–± —Å—Ç–≤–æ—Ä–∏—Ç–∏ middleware, –í–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç–µ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä `@app.middleware("http")` –Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—ó.

–§—É–Ω–∫—Ü—ñ—è middleware –æ—Ç—Ä–∏–º—É—î:

* `–ó–∞–ø–∏—Ç`.
* –§—É–Ω–∫—Ü—ñ—é `call_next`, —è–∫–∞ –ø—Ä–∏–π–º–∞—î `–∑–∞–ø–∏—Ç` —è–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä.
    * –¶—è —Ñ—É–Ω–∫—Ü—ñ—è –ø–µ—Ä–µ–¥–∞—î `–∑–∞–ø–∏—Ç` –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ–π *–æ–ø–µ—Ä–∞—Ü—ñ—ó —à–ª—è—Ö—É*.
    * –ü–æ—Ç—ñ–º –≤–æ–Ω–∞ –ø–æ–≤–µ—Ä—Ç–∞—î `–≤—ñ–¥–ø–æ–≤—ñ–¥—å`, –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω—É —Ü—ñ—î—é *–æ–ø–µ—Ä–∞—Ü—ñ—î—é —à–ª—è—Ö—É*.

* –í–∏ –º–æ–∂–µ—Ç–µ —â–µ –∑–º—ñ–Ω–∏—Ç–∏ `–≤—ñ–¥–ø–æ–≤—ñ–¥—å` –ø–µ—Ä–µ–¥ —Ç–∏–º, —è–∫ –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ —ó—ó.


{* ../../docs_src/middleware/tutorial001.py hl[8:9,11,14] *}

/// tip | –ü–æ—Ä–∞–¥–∞

–ù–µ –∑–∞–±—É–≤–∞–π—Ç–µ, —â–æ –≤–ª–∞—Å–Ω—ñ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –º–æ–∂–Ω–∞ –¥–æ–¥–∞–≤–∞—Ç–∏, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers" class="external-link" target="_blank">–ø—Ä–µ—Ñ—ñ–∫—Å 'X-'</a>.

–ê–ª–µ —è–∫—â–æ —É –í–∞—Å —î –≤–ª–∞—Å–Ω—ñ –∑–∞–≥–æ–ª–æ–≤–∫–∏, —è–∫—ñ –í–∏ —Ö–æ—á–µ—Ç–µ, —â–æ–± –±—Ä–∞—É–∑–µ—Ä–Ω–∏–π –∫–ª—ñ—î–Ω—Ç –º—ñ–≥ –ø–æ–±–∞—á–∏—Ç–∏, –ø–æ—Ç—Ä—ñ–±–Ω–æ –¥–æ–¥–∞—Ç–∏ —ó—Ö –¥–æ –í–∞—à–æ—ó –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó CORS (–¥–∏–≤. [CORS (–û–±–º—ñ–Ω —Ä–µ—Å—É—Ä—Å–∞–º–∏ –º—ñ–∂ —Ä—ñ–∑–Ω–∏–º–∏ –¥–∂–µ—Ä–µ–ª–∞–º–∏)](cors.md){.internal-link target=_blank} –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ `expose_headers`, –æ–ø–∏—Å–∞–Ω–æ–≥–æ –≤ <a href="https://www.starlette.io/middleware/#corsmiddleware" class="external-link" target="_blank">–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—ó Starlette –ø–æ CORS</a>.

///

/// note | –¢–µ—Ö–Ω—ñ—á–Ω—ñ –¥–µ—Ç–∞–ª—ñ

–í–∏ —Ç–∞–∫–æ–∂ –º–æ–∂–µ—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ `from starlette.requests import Request`.

**FastAPI** –Ω–∞–¥–∞—î —Ü–µ –¥–ª—è –í–∞—à–æ—ó –∑—Ä—É—á–Ω–æ—Å—Ç—ñ —è–∫ —Ä–æ–∑—Ä–æ–±–Ω–∏–∫–∞. –ê–ª–µ –≤—ñ–Ω –ø–æ—Ö–æ–¥–∏—Ç—å –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ –∑—ñ Starlette.

///

### –î–æ —ñ –ø—ñ—Å–ª—è `response`(`–≤—ñ–¥–ø–æ–≤—ñ–¥—ñ`)

–í–∏ –º–æ–∂–µ—Ç–µ –¥–æ–¥–∞—Ç–∏ –∫–æ–¥, —è–∫–∏–π –±—É–¥–µ –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏—Å—è –∑ `–∑–∞–ø–∏—Ç–æ–º` (`request`), –¥–æ —Ç–æ–≥–æ, —è–∫ –π–æ–≥–æ –æ–±—Ä–æ–±–∏—Ç—å –±—É–¥—å-—è–∫–∞ *–æ–ø–µ—Ä–∞—Ü—ñ—è —à–ª—è—Ö—É* (*path operation*).

–¢–∞–∫–æ–∂ –í–∏ –º–æ–∂–µ—Ç–µ –¥–æ–¥–∞—Ç–∏ –∫–æ–¥, —è–∫–∏–π –±—É–¥–µ –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏—Å—è –ø—ñ—Å–ª—è —Ç–æ–≥–æ, —è–∫ `–≤—ñ–¥–ø–æ–≤—ñ–¥—å` (`response`) –±—É–¥–µ –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ, –ø–µ—Ä–µ–¥ —Ç–∏–º —è–∫ –π–æ–≥–æ –ø–æ–≤–µ—Ä–Ω—É—Ç–∏.

–ù–∞–ø—Ä–∏–∫–ª–∞–¥, –í–∏ –º–æ–∂–µ—Ç–µ –¥–æ–¥–∞—Ç–∏ –≤–ª–∞—Å–Ω–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ `X-Process-Time`, —è–∫–∏–π –º—ñ—Å—Ç–∏—Ç–∏–º–µ —á–∞—Å —É —Å–µ–∫—É–Ω–¥–∞—Ö, —è–∫–∏–π –≤–∏—Ç—Ä–∞—Ç–∏–≤—Å—è –Ω–∞ –æ–±—Ä–æ–±–∫—É –∑–∞–ø–∏—Ç—É —Ç–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—é –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ:

{* ../../docs_src/middleware/tutorial001.py hl[10,12:13] *}


/// tip | –ü—ñ–¥–∫–∞–∑–∫–∞

–¢—É—Ç –º–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ <a href="https://docs.python.org/3/library/time.html#time.perf_counter" class="external-link" target="_blank">`time.perf_counter()`</a> –∑–∞–º—ñ—Å—Ç—å `time.time()` –æ—Å–∫—ñ–ª—å–∫–∏ –≤—ñ–Ω –º–æ–∂–µ –±—É—Ç–∏ –±—ñ–ª—å—à —Ç–æ—á–Ω–∏–º –¥–ª—è —Ç–∞–∫–∏—Ö –≤–∏–ø–∞–¥–∫—ñ–≤. ü§ì

///

## –Ü–Ω—à—ñ middlewares

–í–∏ –º–æ–∂–µ—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ –ø—Ä–æ—á–∏—Ç–∞—Ç–∏ –±—ñ–ª—å—à–µ –ø—Ä–æ —ñ–Ω—à—ñ middlewares –≤ [Advanced User Guide: Advanced Middleware](../advanced/middleware.md){.internal-link target=_blank}.

–í–∏ –¥—ñ–∑–Ω–∞—î—Ç–µ—Å—å, —è–∫ –æ–±—Ä–æ–±–ª—è—Ç–∏ <abbr title="Cross-Origin Resource Sharing">CORS</abbr> –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é middleware –≤ –Ω–∞—Å—Ç—É–ø–Ω–æ–º—É —Ä–æ–∑–¥—ñ–ª—ñ.
