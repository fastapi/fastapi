# æ›´å¤§çš„åº”ç”¨ç¨‹åº - å¤šä¸ªæ–‡ä»¶

å¦‚æœæ‚¨æ­£åœ¨æ„å»ºä¸€ä¸ªåº”ç”¨ç¨‹åºæˆ–web APIï¼Œå¾ˆå°‘ä¼šå°†æ‰€æœ‰çš„å†…å®¹éƒ½æ”¾åœ¨å•ä¸ªæ–‡ä»¶ä¸­ã€‚

**FastAPI** æä¾›äº†ä¸€ç§æ–¹ä¾¿çš„å·¥å…·æ¥æ„é€ åº”ç”¨ç¨‹åºï¼ŒåŒæ—¶ä¿æŒæ‰€æœ‰çš„çµæ´»æ€§ã€‚

!!! info
    å¦‚æœä½ ä½¿ç”¨è¿‡ Flask, è¿™å°†ç›¸å½“äº Flask çš„è“å›¾(Blueprints)ã€‚

## æ–‡ä»¶ç»“æ„ç¤ºä¾‹

å‡è®¾ä½ æœ‰ä¸€ä¸ªè¿™æ ·çš„æ–‡ä»¶ç»“æ„:

```
.
â”œâ”€â”€ app
â”‚Â Â  â”œâ”€â”€ __init__.py
â”‚Â Â  â”œâ”€â”€ main.py
â”‚Â Â  â”œâ”€â”€ dependencies.py
â”‚Â Â  â””â”€â”€ routers
â”‚Â Â  â”‚   â”œâ”€â”€ __init__.py
â”‚Â Â  â”‚   â”œâ”€â”€ items.py
â”‚Â Â  â”‚   â””â”€â”€ users.py
â”‚Â Â  â””â”€â”€ internal
â”‚Â Â      â”œâ”€â”€ __init__.py
â”‚Â Â      â””â”€â”€ admin.py
```

!!! tip
    æœ‰å‡ ä¸ª `__init__.py` æ–‡ä»¶: æ¯ä¸ªç›®å½•æˆ–å­ç›®å½•ä¸­éƒ½æœ‰ä¸€ä¸ªã€‚

    è¿™å…è®¸å°†ä»£ç ä»ä¸€ä¸ªæ–‡ä»¶å¯¼å…¥åˆ°å¦ä¸€ä¸ªæ–‡ä»¶ä¸­ã€‚

    ä¾‹å¦‚ï¼Œåœ¨ `app/main.py` ä½ å¯ä»¥æœ‰è¿™æ ·ä¸€è¡Œ:

    ```
    from app.routers import items
    ```

* `app` ç›®å½•åŒ…å«æ‰€æœ‰çš„å†…å®¹ã€‚å®ƒåŒ…å«ä¸€ä¸ªç©ºæ–‡ä»¶ `app/__init__.py`, å› æ­¤å®ƒæ˜¯ä¸€ä¸ª "Python åŒ…" (ä¸€ä¸ª "Python æ¨¡å—" æ¨¡å—çš„é›†åˆ): `app` ã€‚
* å®ƒåŒ…å«ä¸€ä¸ª `app/main.py` æ–‡ä»¶ã€‚å®ƒåœ¨ä¸€ä¸ª Python åŒ…çš„å†…éƒ¨ (ä¸€ä¸ªåŒ…å« `__init__.py` æ–‡ä»¶çš„ç›®å½•)ï¼Œ ä»–æ˜¯é‚£ä¸ªåŒ…çš„çš„ä¸€ä¸ª "æ¨¡å—": `app.main` ã€‚
* ä¹Ÿæœ‰ä¸€ä¸ª `app/dependencies.py` æ–‡ä»¶, å°±åƒ `app/main.py`, å®ƒæ˜¯ä¸€ä¸ª "æ¨¡å—": `app.dependencies` ã€‚
* æœ‰ä¸€ä¸ªå­ç›®å½• `app/routers/` å…·æœ‰å¦å¤–ä¸€ä¸ª `__init__.py`, å› æ­¤å®ƒæ˜¯ä¸€ä¸ª "Python å­åŒ…": `app.routers` ã€‚
* æ–‡ä»¶ `app/routers/items.py` åœ¨åŒ… `app/routers/` å†…éƒ¨, å› æ­¤å®ƒæ˜¯ä¸€ä¸ªå­æ¨¡å—: `app.routers.items` ã€‚
* `app/routers/users.py` æ–‡ä»¶ç±»ä¼¼, æ˜¯å¦å¤–ä¸€ä¸ªå­æ¨¡å—: `app.routers.users`.
* è¿˜æœ‰å¦å¤–ä¸€ä¸ªå­ç›®å½• `app/internal/` å’Œå¦å¤–ä¸€ä¸ª `__init__.py` ç›®å½•, å› æ­¤å®ƒæ˜¯å¦å¤–ä¸€ä¸ª "Python å­åŒ…": `app.internal` ã€‚
* æ–‡ä»¶ `app/internal/admin.py` æ˜¯å¦å¤–ä¸€ä¸ªå­æ¨¡å—: `app.internal.admin` ã€‚

<img src="/img/tutorial/bigger-applications/package.svg">

ç›¸åŒçš„æ–‡ä»¶ç»“æ„çš„æ³¨é‡Š:

```
.
â”œâ”€â”€ app                  # "app" æ˜¯ä¸€ä¸ª Python åŒ…
â”‚Â Â  â”œâ”€â”€ __init__.py      # è¿™ä¸ªæ–‡ä»¶å°† "app" å˜æˆ "Python åŒ…"
â”‚Â Â  â”œâ”€â”€ main.py          # "main" æ¨¡å—, å¦‚ï¼š å¯¼å…¥ app.main
â”‚Â Â  â”œâ”€â”€ dependencies.py  # "dependencies" æ¨¡å—, å¦‚ï¼š å¯¼å…¥ app.dependencies
â”‚Â Â  â””â”€â”€ routers          # "routers" æ˜¯ä¸€ä¸ª "Python å­åŒ…"
â”‚Â Â  â”‚   â”œâ”€â”€ __init__.py  # å°† "routers" å˜æˆ "Python å­åŒ…"
â”‚Â Â  â”‚   â”œâ”€â”€ items.py     # "items" å­æ¨¡å—, å¦‚ï¼š å¯¼å…¥ app.routers.items
â”‚Â Â  â”‚   â””â”€â”€ users.py     # "users" å­æ¨¡å—, å¦‚ï¼š å¯¼å…¥ app.routers.users
â”‚Â Â  â””â”€â”€ internal         # "internal" æ˜¯ä¸€ä¸ª "Python å­åŒ…"
â”‚Â Â      â”œâ”€â”€ __init__.py  # å°† "internal" å˜æˆ "Python å­åŒ…"
â”‚Â Â      â””â”€â”€ admin.py     # "admin" å­æ¨¡å—, å¦‚ï¼š å¯¼å…¥ app.internal.admin
```

## `APIRouter`

è®©æˆ‘ä»¬å‡è®¾ä¸“é—¨å¤„ç†ç”¨æˆ·çš„æ–‡ä»¶æ˜¯`/app/routers/users.py` å­æ¨¡å—ã€‚

æ‚¨å¸Œæœ›å°†ä¸ç”¨æˆ·ç›¸å…³çš„ *è·¯å¾„æ“ä½œ* ä¸ä»£ç çš„å…¶ä½™éƒ¨åˆ†åˆ†å¼€ï¼Œä»¥ä¿æŒæ¡ç†æ€§ã€‚

ä½†å®ƒä»ç„¶æ˜¯ç›¸åŒçš„**FastAPI** åº”ç”¨ç¨‹åº/web API çš„ä¸€éƒ¨åˆ†(å®ƒæ˜¯ç›¸åŒçš„ "Python åŒ…" çš„ä¸€éƒ¨åˆ†)ã€‚

æ‚¨å¯ä»¥ä½¿ç”¨ `APIRouter` åˆ›å»ºè¯¥æ¨¡å—çš„ *è·¯å¾„æ“ä½œ* ã€‚

### å¯¼å…¥ `APIRouter`

å¯¼å…¥å®ƒå¹¶åˆ›å»ºä¸€ä¸ª "å®ä¾‹"ï¼Œå°±åƒä½ å¯¼å…¥ç±» `FastAPI` ä¸€æ ·:

```Python hl_lines="1  3"
{!../../../docs_src/bigger_applications/app/routers/users.py!}
```

### ä½¿ç”¨ `APIRouter` å®šä¹‰ *è·¯å¾„æ“ä½œ*

ç„¶åä½ ç”¨å®ƒæ¥å£°æ˜ä½ çš„ *è·¯å¾„æ“ä½œ* ã€‚

ä½¿ç”¨å®ƒçš„æ–¹å¼ä¸ `FastAPI` ç±»ç›¸åŒ:

```Python hl_lines="6  11  16"
{!../../../docs_src/bigger_applications/app/routers/users.py!}
```

You can think of `APIRouter` as a "mini `FastAPI`" class. ä½ å¯ä»¥æŠŠ `APIRouter` çœ‹ä½œä¸€ä¸ª "è¿·ä½ çš„ `FastAPI`" ç±»

æ”¯æŒæ‰€æœ‰ç›¸åŒçš„é€‰é¡¹ã€‚

æ‰€æœ‰ç›¸åŒçš„ `parameters`, `responses`, `dependencies`, `tags` ç­‰ç­‰ã€‚

!!! tip
    åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå˜é‡è¢«ç§°ä¸º `router` ï¼Œä½†æ˜¯æ‚¨å¯ä»¥éšæ„å‘½åå®ƒã€‚

æˆ‘ä»¬å°†æŠŠè¿™ä¸ª `APIRouter` åº”ç”¨åœ¨ `FastAPI` ä¸»åº”ç”¨ç¨‹åºä¸­ï¼Œä½†é¦–å…ˆï¼Œè®©æˆ‘ä»¬æ£€æŸ¥ä¾èµ–å…³ç³»å’Œå¦ä¸€ä¸ª `APIRouter` ã€‚

## ä¾èµ–é¡¹

æˆ‘ä»¬çœ‹åˆ°ï¼Œæˆ‘ä»¬å°†éœ€è¦åœ¨åº”ç”¨ç¨‹åºçš„å‡ ä¸ªåœ°æ–¹ä½¿ç”¨ä¸€äº›ä¾èµ–é¡¹ã€‚

æ‰€ä»¥æˆ‘ä»¬æŠŠå®ƒä»¬æ”¾åœ¨å®ƒä»¬è‡ªå·±çš„ `ä¾èµ–` æ¨¡å—(`app/dependencies.py`)ä¸­ã€‚

æˆ‘ä»¬ç°åœ¨å°†ä½¿ç”¨ä¸€ä¸ªç®€å•çš„ä¾èµ–æ¥è¯»å–ä¸€ä¸ªè‡ªå®šä¹‰çš„ `X-Token` æ¶ˆæ¯å¤´:

```Python hl_lines="1  4-6"
{!../../../docs_src/bigger_applications/app/dependencies.py!}
```

!!! tip
    We are using an invented header to simplify this example. æˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ªè™šæ„çš„æ¶ˆæ¯å¤´æ¥ç®€åŒ–è¿™ä¸ªä¾‹å­ã€‚

    ä½†åœ¨å®é™…æƒ…å†µä¸‹ï¼Œä½¿ç”¨é›†æˆçš„ [Security utilities](./security/index.md){.internal-link target=_blank} ä¼šå¾—åˆ°æ›´å¥½çš„ç»“æœã€‚

## å¦ä¸€ä¸ª `APIRouter` æ¨¡å—

å‡è®¾è¿˜æœ‰ä¸“é—¨ç”¨äºå¤„ç†åº”ç”¨ç¨‹åºä¸­çš„ "é¡¹ç›®" çš„ç«¯ç‚¹åœ¨æ¨¡å— `app/routers/items.py` ä¸­ã€‚

ä½ æœ‰å¤„ç†å¦‚ä¸‹è·¯å¾„çš„ *è·¯å¾„æ“ä½œ*:

* `/items/`
* `/items/{item_id}`

ç»“æ„ä¸ `app/routers/users.py` ç›¸åŒã€‚

ä½†æ˜¯æˆ‘ä»¬æƒ³è¦æ›´èªæ˜ä¸€ç‚¹ï¼Œç¨å¾®ç®€åŒ–ä¸€ä¸‹ä»£ç ã€‚

We know all the *path operations* in this module have the same: æˆ‘ä»¬çŸ¥é“è¿™ä¸ªæ¨¡å—ä¸­æ‰€æœ‰çš„ *è·¯å¾„æ“ä½œ* éƒ½å…·æœ‰ç›¸åŒçš„:

* è·¯å¾„ `å‰ç¼€`: `/items`ã€‚
* `æ ‡ç­¾`: (åªæœ‰ä¸€ä¸ªæ ‡ç­¾: `items`)ã€‚
* é¢å¤–çš„ `å“åº”`ã€‚
* `ä¾èµ–é¡¹`: ä»–ä»¬éƒ½éœ€è¦æˆ‘ä»¬åˆ›å»ºçš„ `X-Token` ä¾èµ–é¡¹ã€‚

 å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å°†å®ƒæ·»åŠ åˆ° `APIRouter` ï¼Œè€Œä¸æ˜¯å°†æ‰€æœ‰è¿™äº›æ·»åŠ åˆ°æ¯ä¸ª *è·¯å¾„æ“ä½œ* ä¸­ã€‚

```Python hl_lines="5-10  16  21"
{!../../../docs_src/bigger_applications/app/routers/items.py!}
```

å› ä¸ºæ¯ä¸ª*è·¯å¾„æ“ä½œ* çš„è·¯å¾„å¿…é¡»ä»¥ `/` å¼€å¤´ï¼Œä¾‹å¦‚:

```Python hl_lines="1"
@router.get("/{item_id}")
async def read_item(item_id: str):
    ...
```

...å‰ç¼€ä¸èƒ½åœ¨ç»“å°¾åŒ…å« `/` ã€‚

æ‰€ä»¥ï¼Œè¿™ä¸ªä¾‹å­ä¸­çš„å‰ç¼€æ˜¯ `/items` ã€‚

æˆ‘ä»¬ä¹Ÿå¯ä»¥å¢åŠ ä¸€ä¸ª `tags` çš„åˆ—è¡¨ï¼Œä»¥åŠå°†è¢«åº”ç”¨äºè¿™ä¸ªè·¯ç”±ä¸­æ‰€æœ‰çš„ *è·¯å¾„æ“ä½œ* çš„é¢å¤– `responses` ã€‚

æˆ‘ä»¬å¢åŠ äº†ä¸€ä¸ª `ä¾èµ–é¡¹` çš„åˆ—è¡¨ï¼Œè¿™äº›ä¾èµ–é¡¹å°†è¢«æ·»åŠ åˆ°è·¯ç”±çš„æ‰€æœ‰ *è·¯å¾„æ“ä½œ* ä¸­ï¼Œå¹¶å°†è¢«æ‰§è¡Œ/è§£ææ¯ä¸ªå‘å®ƒä»¬å‘å‡ºçš„è¯·æ±‚ã€‚

!!! tip
    æ³¨æ„ï¼Œå¾ˆåƒ [*è·¯å¾„æ“ä½œè£…é¥°å™¨* ä¸­çš„ä¾èµ–é¡¹](dependencies/dependencies-in-path-operation-decorators.md){.internal-link target=_blank}, ä¸ä¼šå‘ *è·¯å¾„æ“ä½œå‡½æ•°* ä¼ é€’ä»»ä½•å€¼ã€‚

æœ€ç»ˆï¼Œé¡¹ç›®çš„è·¯å¾„æ˜¯:

* `/items/`
* `/items/{item_id}`

...æ­£å¦‚æˆ‘ä»¬è®¾æƒ³çš„é‚£æ ·ã€‚

* ä»–ä»¬è¢«åŒ…å«å•ä¸ªå­—ç¬¦ä¸² `"items"` çš„æ ‡ç­¾åˆ—è¡¨æ ‡è®°ã€‚
    * è¿™äº› "æ ‡ç­¾" å¯¹äºè‡ªåŠ¨äº¤äº’å¼æ–‡æ¡£ç³»ç»Ÿ(ä½¿ç”¨OpenAPI)ç‰¹åˆ«æœ‰ç”¨ã€‚
* å®ƒä»¬éƒ½åŒ…å«é¢„å…ˆè®¾å®šçš„ `responses` ã€‚
* æ‰€æœ‰ *è·¯å¾„æ“ä½œ* å°†æœ‰ä¸€ä¸ªåœ¨å®ƒä»¬è¿è¡Œä¹‹å‰è¯„ä¼°/æ‰§è¡Œçš„ `ä¾èµ–é¡¹` åˆ—è¡¨ã€‚
    * å¦‚æœä½ ä¹Ÿåœ¨ä¸€ä¸ªç‰¹å®šçš„ *è·¯å¾„æ“ä½œ* ä¸­å£°æ˜ä¾èµ–é¡¹, **å®ƒä»¬ä¹Ÿä¼šè¢«æ‰§è¡Œ**ã€‚
    * é¦–å…ˆæ‰§è¡Œè·¯ç”±çš„ä¾èµ–é¡¹ï¼Œç„¶åæ‰§è¡Œè£…é¥°å™¨ä¸­çš„[*è·¯å¾„æ“ä½œè£…é¥°å™¨* ä¸­çš„ `ä¾èµ–é¡¹`](dependencies/dependencies-in-path-operation-decorators.md){.internal-link target=_blank}, ç„¶åæ‰§è¡Œå¸¸è§„çš„å‚æ•°ä¾èµ–é¡¹ã€‚
    * ä½ ä¹Ÿå¯ä»¥æ·»åŠ  [`Security` dependencies with `scopes`](../advanced/security/oauth2-scopes.md){.internal-link target=_blank}ã€‚

!!! tip
    åœ¨ `APIRouter` å¯ä»¥ä¸­æ‹¥æœ‰ `ä¾èµ–é¡¹` ï¼Œä¾‹å¦‚ç”¨äºè¦æ±‚æ•´ä¸ª *è·¯å¾„æ“ä½œ* ç»„è¿›è¡Œèº«ä»½éªŒè¯ã€‚å³ä½¿ä¾èµ–é¡¹æ²¡æœ‰å•ç‹¬æ·»åŠ åˆ°æ¯ä¸ªä¾èµ–é¡¹ä¸­ã€‚

!!! check
    `å‰ç¼€`, `æ ‡ç­¾`, `å“åº”`, å’Œ `ä¾èµ–é¡¹` å‚æ•°(åœ¨è®¸å¤šå…¶ä»–æƒ…å†µä¸‹)åªæ˜¯ **FastAPI** çš„ä¸€ä¸ªç‰¹æ€§ï¼Œå¯ä»¥å¸®åŠ©æ‚¨é¿å…ä»£ç é‡å¤ã€‚

### å¯¼å…¥ä¾èµ–é¡¹

è¿™æ®µä»£ç å­˜åœ¨äºæ¨¡å— `app.routers.items` ä¸­, ä½äº `app/routers/items.py` æ–‡ä»¶ã€‚

æˆ‘ä»¬éœ€è¦ä»æ¨¡å— `app.dependencies` ä¸­è·å–ä¾èµ–å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯æ–‡ä»¶ `app/dependencies.py` ã€‚

æ‰€ä»¥æˆ‘ä»¬å¯¹äºä¾èµ–å…³ç³»ä½¿ç”¨ä¸€ä¸ªç›¸å¯¹å¯¼å…¥ `..` :

```Python hl_lines="3"
{!../../../docs_src/bigger_applications/app/routers/items.py!}
```

#### ç›¸å¯¹å¯¼å…¥å¦‚ä½•å·¥ä½œ

!!! tip
    å¦‚æœæ‚¨å®Œå…¨äº†è§£å¯¼å…¥æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œè¯·ç»§ç»­é˜…è¯»ä¸‹é¢çš„ä¸‹ä¸€èŠ‚ã€‚

ä¸€ä¸ªç‚¹ `.`, æ¯”å¦‚:

```Python
from .dependencies import get_token_header
```

æ„å‘³ç€:

* ä»è¿™ä¸ªæ¨¡å— (`app/routers/items.py` æ–‡ä»¶) æ‰€åœ¨çš„åŒ…å¼€å§‹ (ç›®å½• `app/routers/`)...
* æ‰¾åˆ°æ¨¡å— `dependencies` (ä¸€ä¸ªå‡è±¡çš„æ–‡ä»¶ï¼Œåœ¨ `app/routers/dependencies.py`)...
* å¹¶ä»ä¸­å¯¼å…¥å‡½æ•° `get_token_header`.

ä½†æ˜¯è¿™ä¸ªæ–‡ä»¶å¹¶ä¸å­˜åœ¨ï¼Œæˆ‘ä»¬çš„ä¾èµ–é¡¹åœ¨æ–‡ä»¶ `app/dependencies.py` ä¸­.

è¿˜è®°å¾—æˆ‘ä»¬çš„åº”ç”¨ç¨‹åº/æ–‡ä»¶ç»“æ„æ˜¯ä»€ä¹ˆæ ·çš„å—:

<img src="/img/tutorial/bigger-applications/package.svg">

---

ä¸¤ä¸ªç‚¹ `..`, æ¯”å¦‚:

```Python
from ..dependencies import get_token_header
```

æ„å‘³ç€:

* ä»è¿™ä¸ªæ¨¡å— (`app/routers/items.py` æ–‡ä»¶) æ‰€åœ¨çš„åŒ…å¼€å§‹ (ç›®å½• `app/routers/`) ...
* è½¬åˆ°çˆ¶åŒ… (ç›®å½• `app/`) ...
* åœ¨é‚£é‡Œï¼Œæ‰¾åˆ°æ¨¡å—çš„ `dependencies` (æ–‡ä»¶åœ¨ `app/routers/dependencies.py`) ...
* å¹¶ä»ä¸­å¯¼å…¥å‡½æ•° `get_token_header` ã€‚

å·¥ä½œæ­£å¸¸! ğŸ‰

---

åŒç†ï¼Œå¦‚æœæˆ‘ä»¬ç”¨ä¸‰ä¸ªç‚¹ `...`, æ¯”å¦‚:

```Python
from ...dependencies import get_token_header
```

è¿™æ„å‘³ç€:

* ä»è¿™ä¸ªæ¨¡å— ( `app/routers/items.py`æ–‡ä»¶) æ‰€åœ¨çš„åŒ…å¼€å§‹ (ç›®å½• `app/routers/`)...
* è½¬åˆ°çˆ¶åŒ… (ç›®å½• `app/`)...
* ç„¶åè½¬åˆ°è¯¥åŒ…çš„çˆ¶åŒ… (ç„¶è€Œå¹¶æ²¡æœ‰çˆ¶åŒ…, `app` å·²ç»æ˜¯é¡¶çº§ ğŸ˜±)...
* åœ¨é‚£é‡Œï¼Œæ‰¾åˆ°æ¨¡å—çš„ `dependencies` (æ–‡ä»¶åœ¨ `app/routers/dependencies.py`) ...
* å¹¶ä»ä¸­å¯¼å…¥å‡½æ•° `get_token_header` ã€‚

å®ƒæŒ‡å‘çš„æ˜¯ `app/` ä¸Šå±‚çš„æŸä¸ªåŒ…ï¼Œä»¥åŠå®ƒè‡ªå·±çš„ `__init__.py` æ–‡ä»¶ï¼Œç­‰ã€‚ä½†æˆ‘ä»¬æ²¡æœ‰ã€‚è¿™ä¼šåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­æŠ›å‡ºä¸€ä¸ªé”™è¯¯ã€‚ğŸš¨

ä½†ç°åœ¨ä½ çŸ¥é“äº†å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œæ‰€ä»¥ä½ å¯ä»¥åœ¨ä½ è‡ªå·±çš„åº”ç”¨ä¸­ä½¿ç”¨ç›¸å¯¹å¯¼å…¥ï¼Œä¸ç®¡å®ƒä»¬æœ‰å¤šå¤æ‚ã€‚ğŸ¤“

### Add some custom `tags`, `responses`, and `dependencies`

We are not adding the prefix `/items` nor the `tags=["items"]` to each *path operation* because we added them to the `APIRouter`.

But we can still add _more_ `tags` that will be applied to a specific *path operation*, and also some extra `responses` specific to that *path operation*:

```Python hl_lines="30-31"
{!../../../docs_src/bigger_applications/app/routers/items.py!}
```

!!! tip
    æœ€åè¿™ä¸ªè·¯å¾„æ“ä½œå°†æœ‰æ ‡ç­¾çš„ç»„åˆ: `["items", "custom"]`ã€‚

    æ–‡æ¡£ä¸­ä¹Ÿä¼šæœ‰ä¸¤ä¸ªå“åº”ï¼Œä¸€ä¸ªç”¨äº `404` ï¼Œå¦ä¸€ä¸ªç”¨äº  `403` ã€‚

## `FastAPI` ä¸»ç¨‹åº

ç°åœ¨ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹ `app/main.py` ä¸Šçš„æ¨¡å—ã€‚

è¿™é‡Œæ˜¯å¯¼å…¥å’Œä½¿ç”¨ `FastAPI` ç±»çš„åœ°æ–¹ã€‚

è¿™å°†æ˜¯åº”ç”¨ç¨‹åºä¸­çš„ä¸»æ–‡ä»¶ï¼Œå®ƒå°†æ‰€æœ‰å†…å®¹ç»‘å®šåœ¨ä¸€èµ·ã€‚

ç”±äºæ‚¨çš„å¤§å¤šæ•°é€»è¾‘ç°åœ¨éƒ½ä¿å­˜åœ¨è‡ªå·±çš„ç‰¹å®šæ¨¡å—ä¸­ï¼Œæ‰€ä»¥ä¸»æ–‡ä»¶å°†éå¸¸ç®€å•ã€‚

### å¯¼å…¥ `FastAPI`

åƒå¾€å¸¸ä¸€æ ·å¯¼å…¥ `FastAPI` ç±»å¹¶åˆ›å»ºä¸€ä¸ªå®ä¾‹ã€‚

ä½ ä¹Ÿå¯ä»¥å£°æ˜ [å…¨å±€ä¾èµ–é¡¹](dependencies/global-dependencies.md){.internal-link target=_blank} è¿™å°†ä¸æ¯ä¸ª `APIRouter` çš„ä¾èµ–é¡¹ç»“åˆåœ¨ä¸€èµ·:

```Python hl_lines="1  3  7"
{!../../../docs_src/bigger_applications/app/main.py!}
```

### å¯¼å…¥ `APIRouter`

ç°åœ¨æˆ‘ä»¬å¯¼å…¥æ‹¥æœ‰ `APIRouter` çš„å­æ¨¡å—ï¼š

```Python hl_lines="5"
{!../../../docs_src/bigger_applications/app/main.py!}
```

ç”±äºæ–‡ä»¶ `app/routers/users.py` å’Œ `app/routers/items.py` æ˜¯åŒä¸€ä¸ª Python åŒ… `app` çš„å­æ¨¡å—ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å•ä¸ªç‚¹  `.` ï¼Œä½¿ç”¨ "ç›¸å¯¹å¯¼å…¥" å¯¼å…¥å®ƒä»¬ã€‚ 

### å¯¼å…¥å¦‚ä½•å·¥ä½œ

The section:

```Python
from .routers import items, users
```

æ„æ€æ˜¯:

* ä»è¿™ä¸ªæ¨¡å— (  `app/main.py`æ–‡ä»¶) æ‰€åœ¨çš„åŒ…å¼€å§‹ (ç›®å½•`app/`)...
* è½¬åˆ°å­åŒ… `routers` (ç›®å½• `app/routers/`)...
* ä»ä¸­å¯¼å…¥å­æ¨¡å— `items` (æ–‡ä»¶ `app/routers/items.py`) å’Œ `users` (æ–‡ä»¶ `app/routers/users.py`)...

æ¨¡å— `items` å…·æœ‰ä¸€ä¸ªå˜é‡ `router` (`items.router`). è¿™å°±æ˜¯æˆ‘ä»¬åœ¨ `app/routers/items.py` æ–‡ä»¶ä¸­åˆ›å»ºçš„é‚£ä¸ª `APIRouter` å¯¹è±¡ã€‚

ç„¶åæˆ‘ä»¬å¯¹æ¨¡å— `users` åšåŒæ ·çš„äº‹æƒ…ã€‚

æˆ‘ä»¬ä¹Ÿå¯ä»¥åƒè¿™æ ·å¯¼å…¥å®ƒä»¬:

```Python
from app.routers import items, users
```

!!! info
    ç¬¬ä¸€ä¸ªç‰ˆæœ¬æ˜¯ "relative import":

    ```Python
    from .routers import items, users
    ```
    
    ç¬¬äºŒä¸ªç‰ˆæœ¬æ˜¯ "absolute import":

    ```Python
    from app.routers import items, users
    ```

    è¦äº†è§£æ›´å¤šå…³äºPythonåŒ…å’Œæ¨¡å—çš„ä¿¡æ¯ï¼Œè¯·é˜…è¯» <a href="https://docs.python.org/3/tutorial/modules.html" class="external-link" target="_blank">å…³äºæ¨¡å—çš„Pythonå®˜æ–¹æ–‡æ¡£</a>.

### é¿å…åç§°å†²çª

æˆ‘ä»¬ç›´æ¥å¯¼å…¥å­æ¨¡å— `items` ï¼Œè€Œä¸æ˜¯åªå¯¼å…¥å®ƒçš„å˜é‡ `router` ã€‚

è¿™æ˜¯å› ä¸ºåœ¨å­æ¨¡å— `users` ä¸­è¿˜æœ‰ä¸€ä¸ªåä¸º `router` çš„å˜é‡ã€‚



å¦‚æœæˆ‘ä»¬ä¸€ä¸ªæ¥ä¸€ä¸ªåœ°å¯¼å…¥ï¼Œæ¯”å¦‚:
```Python
from .routers.items import router
from .routers.users import router
```

æ¥è‡ª `users` çš„ `router` å°†è¦†ç›–æ¥è‡ª `items` çš„ `router` ï¼Œæˆ‘ä»¬å°†ä¸èƒ½å¤ŸåŒæ—¶æ‹¥æœ‰ä¸¤è€…ã€‚

æ‰€ä»¥ï¼Œä¸ºäº†èƒ½å¤Ÿåœ¨åŒä¸€ä¸ªæ–‡ä»¶ä¸­ä½¿ç”¨å®ƒä»¬ï¼Œæˆ‘ä»¬ç›´æ¥å¯¼å…¥å­æ¨¡å—:

```Python hl_lines="4"
{!../../../docs_src/bigger_applications/app/main.py!}
```

### å¼•å…¥ `users` å’Œ `items` çš„ `APIRouter`

Now, let's include the `router`s from the submodules `users` and `items`: ç°åœ¨ï¼Œè®©æˆ‘ä»¬å¼•å…¥æ¥è‡ªå­æ¨¡å— `users` å’Œ `items` çš„ `router`:

```Python hl_lines="10-11"
{!../../../docs_src/bigger_applications/app/main.py!}
```

!!! info
    `users.router` åŒ…å«æ¥è‡ªæ–‡ä»¶ `app/routers/users.py` çš„ `APIRouter` ã€‚

    `items.router` åŒ…å«æ¥è‡ªæ–‡ä»¶ `app/routers/items.py` çš„ `APIRouter` ã€‚

é€šè¿‡ `app.include_router()` æˆ‘ä»¬å¯ä»¥å°†æ¯ä¸ª `APIRouter` æ·»åŠ åˆ° `FastAPI` ä¸»ç¨‹åºã€‚

It will include all the routes from that router as part of it.å®ƒå°†å¼•å…¥æ¥è‡ªè¯¥è·¯ç”±æ¨¡å—çš„æ‰€æœ‰è·¯ç”±ä½œä¸ºå®ƒçš„ä¸€éƒ¨åˆ†ã€‚

!!! note "æŠ€æœ¯ç»†èŠ‚"
    å®ƒå®é™…ä¸Šä¼šåœ¨å†…éƒ¨ä¸ºåœ¨ `APIRouter` ä¸­å£°æ˜çš„æ¯ä¸ª *è·¯å¾„æ“ä½œ* åˆ›å»ºä¸€ä¸ª *è·¯å¾„æ“ä½œ* ã€‚

    æ‰€ä»¥ï¼Œåœ¨åå°ï¼Œå®ƒå®é™…ä¸Šä¼šåƒæ‰€æœ‰ä¸œè¥¿éƒ½æ˜¯åŒä¸€ä¸ªåº”ç”¨ä¸€æ ·å·¥ä½œã€‚

!!! check
    æ‚¨ä¸å¿…æ‹…å¿ƒåœ¨åŒ…å«è·¯ç”±æ—¶çš„æ€§èƒ½é—®é¢˜ã€‚

    è¿™å°†èŠ±è´¹å‡ å¾®ç§’çš„æ—¶é—´ï¼Œå¹¶ä¸”åªä¼šåœ¨å¯åŠ¨æ—¶å‘ç”Ÿã€‚

    æ‰€ä»¥å®ƒä¸ä¼šå½±å“æ€§èƒ½ã€‚âš¡

### å¼•å…¥å…·æœ‰è‡ªå®šä¹‰ `å‰ç¼€`, `æ ‡ç­¾`, `å“åº”`, å’Œ `ä¾èµ–é¡¹` çš„ `APIRouter`

ç°åœ¨ï¼Œè®©æˆ‘ä»¬æƒ³è±¡ä¸€ä¸‹ä½ çš„ç»„ç»‡ç»™ä½ ä¸€ä¸ª `app/internal/admin.py` æ–‡ä»¶ã€‚

å®ƒåŒ…å«å¸¦æœ‰ä¸€äº›ç®¡ç†(admin) *è·¯å¾„æ“ä½œ* çš„ `APIRouter` ï¼Œæ‚¨çš„ç»„ç»‡å¯ä»¥åœ¨å‡ ä¸ªé¡¹ç›®ä¹‹é—´å…±äº«å®ƒã€‚

å¯¹äºè¿™ä¸ªä¾‹å­æ¥è¯´ï¼Œå®ƒéå¸¸ç®€å•ã€‚ä½†æˆ‘ä»¬å‡è®¾ï¼Œå› ä¸ºå®ƒæ˜¯ä¸ç»„ç»‡ä¸­çš„å…¶ä»–é¡¹ç›®å…±äº«çš„ï¼Œæˆ‘ä»¬ä¸èƒ½ä¿®æ”¹å®ƒï¼Œå¹¶ç›´æ¥åœ¨`APIRouter` ä¸Šæ·»åŠ  `å‰ç¼€`, `ä¾èµ–é¡¹`, `æ ‡ç­¾` ç­‰:

```Python hl_lines="3"
{!../../../docs_src/bigger_applications/app/internal/admin.py!}
```

ä½†æ˜¯æˆ‘ä»¬ä»ç„¶æƒ³åœ¨å¼•å…¥ `APIRouter` æ—¶è®¾ç½®ä¸€ä¸ªè‡ªå®šä¹‰çš„ `å‰ç¼€` ï¼Œè¿™æ ·å®ƒçš„æ‰€æœ‰ *è·¯å¾„æ“ä½œ* éƒ½ä»¥ `/admin` å¼€å§‹ï¼Œæˆ‘ä»¬æƒ³ç”¨å·²æ‹¥æœ‰çš„ `ä¾èµ–` æ¥ä¿æŠ¤å®ƒï¼Œå¹¶ä¸”æˆ‘ä»¬æƒ³åŒ…å« `æ ‡ç­¾` å’Œ `å“åº”` ã€‚

æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¼ é€’è¿™äº›å‚æ•°åˆ° `app.include_router()` æ¥å£°æ˜ï¼Œè€Œä¸éœ€è¦ä¿®æ”¹åŸå§‹çš„ `APIRouter` :

```Python hl_lines="14-17"
{!../../../docs_src/bigger_applications/app/main.py!}
```

è¿™æ ·ï¼ŒåŸå§‹çš„ `APIRouter` å°†ä¿æŒä¸å˜ï¼Œè¿™æ ·æˆ‘ä»¬ä»ç„¶å¯ä»¥å…±äº«ç›¸åŒçš„ `app/internal/admin.py` çš„æ–‡ä»¶å’Œç»„ç»‡ä¸­çš„å…¶ä»–é¡¹ç›®ã€‚

The result is that in our app, each of the *path operations* from the `admin` module will have: ç»“æœæ˜¯ï¼Œåœ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºï¼Œæ¯ä¸ªä» `admin` æ¨¡å—å¼•å…¥çš„ *è·¯å¾„æ“ä½œ* å°†æœ‰:

* å‰ç¼€ `/admin`.
* æ ‡ç­¾ `admin`.
* ä¾èµ–é¡¹ `get_token_header`.
* å“åº” `418`. ğŸµ

ä½†è¿™åªä¼šå½±å“appä¸­çš„ `APIRouter` è€Œä¸ä¼šå½±å“å…¶ä»–ä½¿ç”¨å®ƒçš„ä»£ç ã€‚

ä¾‹å¦‚ï¼Œå…¶ä»–é¡¹ç›®å¯ä»¥ä½¿ç”¨ç›¸åŒçš„ `APIRouter` ï¼Œä½†ä½¿ç”¨ä¸åŒçš„èº«ä»½éªŒè¯æ–¹æ³•ã€‚

### å¼•å…¥ä¸€ä¸ª *path operation*

æˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥åœ¨ `FastAPI` åº”ç”¨ä¸­æ·»åŠ  *è·¯å¾„æ“ä½œ*ã€‚

æˆ‘ä»¬åœ¨è¿™é‡Œåšçš„â€¦åªæ˜¯ä¸ºäº†è¡¨æ˜æˆ‘ä»¬å¯ä»¥ğŸ¤·:

```Python hl_lines="21-23"
{!../../../docs_src/bigger_applications/app/main.py!}
```

å®ƒå°†ä¸æ‰€æœ‰å…¶ä»–ç”± `app.include_router()` æ·»åŠ çš„ *è·¯å¾„æ“ä½œ* ä¸€èµ·æ­£å¸¸å·¥ä½œã€‚

!!! info "éå¸¸æŠ€æœ¯ç»†èŠ‚"
    **æ³¨**: è¿™æ˜¯ä¸€ä¸ªä½ å¯èƒ½å¯ä»¥ **ç›´æ¥è·³è¿‡** çš„éå¸¸æŠ€æœ¯æ€§çš„ç»†èŠ‚ï¼Œ

    ---

    `APIRouter` å¹¶æ²¡æœ‰è¢« "æŒ‚è½½" ï¼Œå®ƒä»¬æ²¡æœ‰ä¸åº”ç”¨ç¨‹åºçš„å…¶ä½™éƒ¨åˆ†éš”ç¦»ã€‚

    è¿™æ˜¯å› ä¸ºæˆ‘ä»¬å¸Œæœ›åœ¨OpenAPIæ¨¡å¼å’Œç”¨æˆ·ç•Œé¢ä¸­åŒ…å«å®ƒä»¬çš„ *è·¯å¾„æ“ä½œ* ã€‚

    ç”±äºæˆ‘ä»¬ä¸èƒ½ä»…éš”ç¦»å®ƒä»¬å¹¶ç‹¬ç«‹äºå…¶ä»–æ“ä½œ "æŒ‚è½½" å®ƒä»¬ï¼Œæ‰€ä»¥ *è·¯å¾„æ“ä½œ* è¢« "å…‹éš†" (é‡æ–°åˆ›å»º)äº†ï¼Œè€Œä¸æ˜¯ç›´æ¥åŒ…å«åœ¨å…¶ä¸­ã€‚

## æ£€æŸ¥è‡ªåŠ¨APIæ–‡æ¡£

ç°åœ¨æ‰§è¡Œ `uvicorn`, ä½¿ç”¨æ¨¡å— `app.main` å’Œå˜é‡ `app` :

<div class="termy">

```console
$ uvicorn app.main:app --reload

<span style="color: green;">INFO</span>:     Uvicorn running on http://127.0.0.1:8000 (Press CTRL+C to quit)
```

</div>

ç„¶ååœ¨æµè§ˆå™¨è®¿é—® <a href="http://127.0.0.1:8000/docs" class="external-link" target="_blank">http://127.0.0.1:8000/docs</a> æ‰“å¼€æ–‡æ¡£ã€‚

ä½ ä¼šçœ‹åˆ°è‡ªåŠ¨APIæ–‡æ¡£ï¼ŒåŒ…æ‹¬æ‰€æœ‰å­æ¨¡å—çš„è·¯å¾„ï¼Œä½¿ç”¨æ­£ç¡®çš„è·¯å¾„(å’Œå‰ç¼€)å’Œæ­£ç¡®çš„æ ‡ç­¾:

<img src="/img/tutorial/bigger-applications/image01.png">

## ä½¿ç”¨ä¸åŒçš„ `å‰ç¼€` å¤šæ¬¡åŒ…å«ç›¸åŒçš„è·¯ç”±

ä½ ä¹Ÿå¯ä»¥å¤šæ¬¡ä½¿ç”¨ `.include_router()` å’Œä¸åŒçš„å‰ç¼€ï¼Œå¼•å…¥ *ç›¸åŒçš„* è·¯ç”±ã€‚

è¿™å¯èƒ½æ˜¯æœ‰ç”¨çš„ï¼Œä¾‹å¦‚ï¼Œä»¥ä¸åŒçš„å‰ç¼€å…¬å¼€ç›¸åŒçš„APIï¼Œä¾‹å¦‚ `/api/v1` å’Œ `/api/latest`.

è¿™æ˜¯ä¸€ç§é«˜çº§ç”¨æ³•ï¼Œæ‚¨å¯èƒ½å¹¶ä¸çœŸæ­£éœ€è¦å®ƒï¼Œä½†å®ƒç¡®å®å­˜åœ¨ï¼Œä»¥é˜²æ‚¨éœ€è¦ã€‚

## åœ¨ä¸€ä¸ª `APIRouter` ä¸­åŒ…å«å¦å¤–ä¸€ä¸ª `APIRouter`

ä¸åœ¨ `FastAPI` åº”ç”¨ç¨‹åºä¸­åŒ…å«ä¸€ä¸ª `APIRouter` çš„æ–¹å¼ç›¸åŒï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•åœ¨ä¸€ä¸ª `APIRouter` ä¸­åŒ…å«å¦å¤–ä¸€ä¸ª `APIRouter` :

```Python
router.include_router(other_router)
```

è¯¥æ“ä½œéœ€è¦ç¡®ä¿åœ¨ `FastAPI` åº”ç”¨ç¨‹åºä¸­åŒ…å« `router` ä¹‹å‰å®Œæˆï¼Œè¿™æ ·æ¥è‡ª `other_router` çš„ *è·¯å¾„æ“ä½œ* ä¹Ÿä¼šåŒ…å«åœ¨å†…ã€‚
