# HTTPSについて

HTTPSを、「有効」か「無効」にされるだけの何かだと考えることは簡単です。

しかし実態は、より複雑です。

!!! tip "豆知識"
    もし急いでいたり、気にならない場合は、次のセクションに進んで構築手順を確認して下さい。

コンシューマの観点からHTTPSの基本を学びたい場合は、<a href="https://howhttps.works/" class="external-link" target="_blank">https://howhttps.works/</a>を確認して下さい。

ここで、開発者の観点からHTTPSについて考える際に、覚えておくべきことがいくつかあります:

* サーバーはHTTPSのために、サードパーティによって生成された「証明書」が必要です。
    * それらの証明書は、実際には「生成」されるものではなく、サードパーティから取得するものです。
* 証明書は有効期限があります。
    * 期限切れを起こします。
    * そうなった場合、サードパーティから再取得する必要があります。
* 接続の暗号化はTCPレベルで行われます。
    * HTTPよりも1つ下のレイヤーです。
    * よって、証明と暗号化はHTTPの前に行われます。
* TCPは「ドメイン」を認識しません。IPアドレスについてのみ認識します。
    * リクエストされた特定のドメインに関する情報はHTTPデータの中に入ります。
* HTTPS証明書は特定のドメインであることを「証明」します。しかし、どのドメインで扱われるか知る前にプロトコルと暗号化はTCPレベルで行われます。
* デフォルトでは、これはIPアドレス毎に一つのHTTPS証明書しか持てないことを意味します。
    * サーバの大きさやその中にあるそれぞれのアプリケーションの大きさに依りません。
    * しかし、解決方法はあります。
* <a href="https://en.wikipedia.org/wiki/Server_Name_Indication" class="external-link" target="_blank"><abbr title="Server Name Indication">SNI</abbr></a>と呼ばれるTLSプロトコル (HTTPの前にTCPレベルで暗号化を行う) への拡張機能が存在します。
    * このSNI拡張機能により、ひとつのサーバ (一つのIPアドレスをもつ) に複数のHTTPS証明書を持たせることができて、複数のHTTPSドメイン/アプリケーションにサービスを提供できるようになります。
    * これを動作させるためには、サーバ上でパブリックIPアドレスを持ってアクセスを待ち受けている一つのコンポーネント (プログラム) にサーバ内の全てのHTTPS証明書をもたせなければなりません。
* 安全な接続を実現した後でも、通信プロトコルはHTTPのままです。
    * コンテンツはHTTPプロトコルで送信されているにも関わらず暗号化されます。

サーバー（マシン、ホストなど）で1つのプログラム/ HTTPサーバーを実行し、すべてのHTTPSの処理を管理することは一般的な方法です : 同じサーバーで実行されている実際のHTTPアプリケーション (この場合、**FastAPI**) に復号化されたHTTPリクエストを送信し、アプリケーションからHTTPレスポンスを取得し、適切な証明書を使用して暗号化し、HTTPSを使用してクライアントに送り返します。このサーバーは、しばしば<a href="https://en.wikipedia.org/wiki/TLS_termination_proxy" class="external-link" target="_blank"> TLSターミネーションプロキシ</a>と呼ばれます。

## Let's Encrypt

Let's Encryptがない頃、HTTPS証明書は信頼できるサードパーティから販売されていました。

証明書を取得するプロセスは面倒であり、かなりの事務処理を必要とし、証明書は非常に高価でした。

しかしその後、<a href="https://letsencrypt.org/" class="external-link" target="_blank">Let's Encrypt</a>が作成されました。

これはLinux Foundationのプロジェクトです。自動化された方法で、HTTPS証明書を無料で提供します。これらの証明書はすべての標準的な暗号化セキュリティを使用しており、有効期間が短い（約3か月）です。寿命が短くなるため、セキュリティは優れています。

ドメインは安全に検証され、証明書は自動的に生成されます。証明書の更新を自動化することもできます。

このアイデアは、証明書の取得と更新を自動化して、安全なHTTPSを無料で永久に使用可能にするためのものです。
